---
import { getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import type { HTMLAttributes } from 'astro/types';

interface BackgroundProperty {
  repeat?: string;
  position?: string;
  size?: string;
}

interface Props extends HTMLAttributes<"div"> {
  as?: "div" | "section" | "article";
  gradients?: string[];
  imagePaths?: string[];
  gradient?: string;
  imagePath?: string;
  backgroundProperties?: BackgroundProperty[];
  backgroundProperty?: BackgroundProperty;
  backgroundColor?: string;
  aspectRatio?: string;
  gradientsFirst?: boolean;
  classes?: string;
}

const {
  as = 'div',
  gradients = [],
  gradient,
  imagePaths = [],
  imagePath,
  backgroundProperties = [],
  backgroundProperty,
  backgroundColor = 'transparent',
  aspectRatio = '16 / 9',
  gradientsFirst = true,
  classes,
  ...rest
} = Astro.props;

const defaultBackgroundProperty: BackgroundProperty = {
  repeat: 'no-repeat',
  position: 'center center',
  size: 'cover'
};

const images = import.meta.glob<{ default: ImageMetadata }>('@images/*.{jpeg,jpg,png,gif,webp,avif,svg}');

async function getImageBackground(imagePath: string, backgroundProperty: BackgroundProperty = defaultBackgroundProperty): Promise<string> {
  if (!images[imagePath]) throw new Error(`"${imagePath}" does not exist in glob: "@images/*.{jpeg,jpg,png,gif,webp,avif,svg}"`);
  const imageModule = await images[imagePath]();
  const optimizedImage = await getImage({ src: imageModule.default });

  const { repeat, position, size } = { ...defaultBackgroundProperty, ...backgroundProperty };
  return `url(${optimizedImage.src}) ${repeat} ${position} / ${size}`;
}

async function getImageBackgrounds(imagePaths: string[], backgroundProperties: BackgroundProperty[]): Promise<string[]> {
  return Promise.all(imagePaths.map((imagePath, index) => getImageBackground(imagePath, backgroundProperties[index])));
}

const imageBackgrounds = imagePath
  ? [await getImageBackground(imagePath, backgroundProperty)]
  : await getImageBackgrounds(imagePaths, backgroundProperties);

const gradientsToUse = gradient ? [gradient] : gradients;
const backgrounds = gradientsFirst ? [...gradientsToUse, ...imageBackgrounds] : [...imageBackgrounds, ...gradientsToUse];
const background = backgrounds.join(', ');

const Tag = as;
---

<style>
  .background {
    width: 100%;
    background-color: var(--background-color, transparent);
    aspect-ratio: var(--aspect-ratio, 16 / 9);
    background: var(--background);
  }
</style>

<Tag 
  class:list={['background', classes]} 
  style={`
    --background: ${backgrounds.length > 0 ? background : 'none'};
    --background-color: ${backgroundColor};
    --aspect-ratio: ${aspectRatio};
  `} 
  {...rest}
>
  <slot/>
</Tag>